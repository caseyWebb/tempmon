<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>tempmon</title>

  <style>
    .sensors {
      display: flex;
      justify-content: space-evenly;
    }

    .sensor {
      padding: 20px;
    }

    .sensor .temp {
      font-size: 36px;
    }

    .sensor .label {
      font-size: 16px;
    }
  </style>
</head>

<body>
  <div class="sensors">
    <!-- ko foreach: sensors -->
    <div data-bind="style: { color: color, borderColor: color }">
      <div class="temp" data-bind="text: temp"></div>
      <div class="label" data-bind="text: label"></div>
    </div>
    <!-- /ko -->
  </div>
  <canvas id="daily-graph" height="100%"></canvas>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.5.1/knockout-latest.min.js"
    integrity="sha512-vs7+jbztHoMto5Yd/yinM4/y2DOkPLt0fATcN+j+G4ANY2z4faIzZIOMkpBmWdcxt+596FemCh9M18NUJTZwvw=="
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.bundle.min.js"
    integrity="sha512-vBmx0N/uQOXznm/Nbkp7h0P1RfLSj0HQrFSzV8m7rOGyj30fYAOKHYvCNez+yM8IrfnW0TCodDEjRqf6fodf/Q=="
    crossorigin="anonymous"></script>
  <script>
    const colors = [
      '#37CF62',
      '#8EDFD9',
      '#53A8A5',
      '#00746C',
      '#030E46'
    ]
    const labels = JSON.parse(localStorage.getItem('labels')) || {}
    const ctx = document.getElementById('daily-graph').getContext('2d')
    const viewModel = {
      sensors: ko.observableArray([])
    }

    const fetchHistoricalData = () => fetch('data', { cache: 'no-cache' }).then((res) => res.json())
    const fetchCurrent = () => fetch('current', { cache: 'no-cache' }).then((res) => res.json())

    function createChartDatasets(data) {
      return data.map(([_date, temps]) => {
        const date = new Date(_date)
        return Object.keys(temps).map((sensor) => {
          const temp = temps[sensor]
          return {
            sensor,
            point: {
              x: date,
              y: temps[sensor]
            }
          }
        })
      }).reduce((accum, points) => {
        points.forEach(({ sensor, point }, i) => {
          if (!accum[i]) accum[i] = {
            label: labels[sensor] || sensor,
            borderColor: colors[i],
            fill: false,
            data: []
          }
          accum[i].data.push(point)
        })
        return accum
      }, [])
    }

    function initialize() {
      Promise.all([
        fetchHistoricalData(),
        fetchCurrent()
      ]).then(([data, current]) => {
        drawDailyChart(
          createChartDatasets([...data, [Date.now(), current]])
        )
        updateCurrent(current)
        currentAutoUpdate()
        ko.applyBindings(viewModel, document.body)
      })

      setInterval(() => {
        Promise.all([
          fetchHistoricalData(),
          fetchCurrent()
        ]).then(([data, current]) => drawDailyChart(
          createChartDatasets([...data, [Date.now(), current]])
        ))
      }, 5 * 60 * 1000) // 5 min
    }

    function currentAutoUpdate() {
      fetchCurrent().then(updateCurrent).then(currentAutoUpdate)
    }

    function updateCurrent(data) {
      viewModel.sensors(
        Object.keys(data).map((sensor, i) => ({
          color: colors[i],
          label: labels[sensor] || sensor,
          temp: data[sensor]
        }))
      )
    }

    function drawDailyChart(datasets) {
      return new Chart(ctx, {
        type: 'line',
        data: {
          datasets
        },
        options: {
          scales: {
            xAxes: [{
              type: 'time',
              time: {
                unit: 'hour'
              },
              min: new Date(new Date().setDate(new Date().getDate() - 1))
            }],
            yAxes: [
              {
                type: 'linear',
                scaleLabel: {
                  display: true,
                  labelString: 'Temperature (Celsius)'
                }
              }
            ]
          }
        }
      })
    }

    initialize()
  </script>
</body>

</html>